---
import Layout from '../layouts/Layout.astro';
---

<Layout title="設定 - おでかけカウントダウン" activeTab="settings">
  <div class="settings-container">
    <h1 class="page-title">設定</h1>

    <!-- 通知設定 -->
    <div class="card">
      <h2 class="section-title">通知設定</h2>
      
      <div class="setting-item">
        <div class="setting-info">
          <div class="setting-label">音声通知</div>
          <div class="setting-desc">カウントダウン時に音声で通知します</div>
        </div>
        <label class="toggle-switch">
          <input type="checkbox" id="sound-enabled" checked>
          <span class="toggle-slider"></span>
        </label>
      </div>

      <div class="setting-item">
        <div class="setting-info">
          <div class="setting-label">ブラウザ通知</div>
          <div class="setting-desc">ブラウザのプッシュ通知を使用します</div>
        </div>
        <label class="toggle-switch">
          <input type="checkbox" id="notification-enabled" checked>
          <span class="toggle-slider"></span>
        </label>
      </div>
    </div>

    <!-- 位置情報設定 -->
    <div class="card">
      <h2 class="section-title">位置情報</h2>
      
      <div class="setting-item">
        <div class="setting-info">
          <div class="setting-label">位置情報の使用</div>
          <div class="setting-desc">天気情報取得に使用します</div>
        </div>
        <label class="toggle-switch">
          <input type="checkbox" id="location-enabled" checked>
          <span class="toggle-slider"></span>
        </label>
      </div>
    </div>

    <!-- データ管理 -->
    <div class="card">
      <h2 class="section-title">データ管理</h2>
      
      <button class="btn btn-secondary btn-full" id="export-data">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="7 10 12 15 17 10"></polyline>
          <line x1="12" y1="15" x2="12" y2="3"></line>
        </svg>
        データをエクスポート
      </button>

      <button class="btn btn-secondary btn-full" id="import-data">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="17 8 12 3 7 8"></polyline>
          <line x1="12" y1="3" x2="12" y2="15"></line>
        </svg>
        データをインポート
      </button>
      <input type="file" id="import-file" accept=".json" style="display: none;">

      <button class="btn btn-secondary btn-full" id="clear-data" style="color: var(--color-error); margin-top: 1rem;">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="3 6 5 6 21 6"></polyline>
          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
        </svg>
        すべてのデータを削除
      </button>
    </div>

    <!-- アプリ情報 -->
    <div class="card">
      <h2 class="section-title">アプリ情報</h2>
      
      <div class="info-item">
        <span class="info-label">バージョン</span>
        <span class="info-value">1.0.0</span>
      </div>

      <div class="info-item">
        <span class="info-label">ビルド日</span>
        <span class="info-value">2026年1月2日</span>
      </div>
    </div>

    <!-- リンク -->
    <div class="card">
      <h2 class="section-title">サポート</h2>
      
      <a href="#" class="link-item">
        <span>利用規約</span>
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="9 18 15 12 9 6"></polyline>
        </svg>
      </a>

      <a href="#" class="link-item">
        <span>プライバシーポリシー</span>
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="9 18 15 12 9 6"></polyline>
        </svg>
      </a>

      <a href="#" class="link-item">
        <span>お問い合わせ</span>
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="9 18 15 12 9 6"></polyline>
        </svg>
      </a>
    </div>
  </div>

  <style>
    .settings-container {
      max-width: 600px;
      margin: 0 auto;
    }

    .page-title {
      font-size: 1.75rem;
      font-weight: 700;
      margin-bottom: 1.5rem;
      color: var(--color-text);
    }

    .section-title {
      font-size: 1.125rem;
      font-weight: 600;
      margin-bottom: 1rem;
    }

    .setting-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 0;
      border-bottom: 1px solid var(--color-border);
    }

    .setting-item:last-child {
      border-bottom: none;
    }

    .setting-info {
      flex: 1;
    }

    .setting-label {
      font-weight: 600;
      margin-bottom: 0.25rem;
    }

    .setting-desc {
      font-size: 0.875rem;
      color: var(--color-text-secondary);
    }

    .toggle-switch {
      position: relative;
      width: 48px;
      height: 28px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: #cbd5e1;
      border-radius: 28px;
      transition: 0.3s;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 4px;
      bottom: 4px;
      background: white;
      border-radius: 50%;
      transition: 0.3s;
    }

    .toggle-switch input:checked + .toggle-slider {
      background: var(--color-primary);
    }

    .toggle-switch input:checked + .toggle-slider:before {
      transform: translateX(20px);
    }

    .btn-full {
      width: 100%;
      margin-bottom: 0.75rem;
    }

    .btn-full:last-child {
      margin-bottom: 0;
    }

    .info-item {
      display: flex;
      justify-content: space-between;
      padding: 0.75rem 0;
      border-bottom: 1px solid var(--color-border);
    }

    .info-item:last-child {
      border-bottom: none;
    }

    .info-label {
      color: var(--color-text-secondary);
    }

    .info-value {
      font-weight: 600;
    }

    .link-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 0;
      text-decoration: none;
      color: var(--color-text);
      border-bottom: 1px solid var(--color-border);
      transition: color 0.2s;
    }

    .link-item:hover {
      color: var(--color-primary);
    }

    .link-item:last-child {
      border-bottom: none;
    }
  </style>

  <script>
    import type { AppSettings, LocalStorageData } from '../types';

    // 設定の読み込み
    function loadSettings() {
      const stored = localStorage.getItem('settings');
      const settings: AppSettings = stored ? JSON.parse(stored) : {
        soundEnabled: true,
        musicUrl: '',
        locationEnabled: true,
        notificationEnabled: true
      };

      (document.getElementById('sound-enabled') as HTMLInputElement).checked = settings.soundEnabled;
      (document.getElementById('notification-enabled') as HTMLInputElement).checked = settings.notificationEnabled;
      (document.getElementById('location-enabled') as HTMLInputElement).checked = settings.locationEnabled;

      return settings;
    }

    // 設定の保存
    function saveSettings() {
      const settings: AppSettings = {
        soundEnabled: (document.getElementById('sound-enabled') as HTMLInputElement).checked,
        notificationEnabled: (document.getElementById('notification-enabled') as HTMLInputElement).checked,
        locationEnabled: (document.getElementById('location-enabled') as HTMLInputElement).checked,
        musicUrl: ''
      };

      localStorage.setItem('settings', JSON.stringify(settings));

      // 通知許可のリクエスト
      if (settings.notificationEnabled && 'Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
      }
    }

    // データのエクスポート
    function exportData() {
      const data: LocalStorageData = {
        alarmPatterns: JSON.parse(localStorage.getItem('alarmPatterns') || '[]'),
        settings: JSON.parse(localStorage.getItem('settings') || '{}')
      };

      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `outing-countdown-backup-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // データのインポート
    function importData(file: File) {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data: LocalStorageData = JSON.parse(e.target?.result as string);
          
          if (data.alarmPatterns) {
            localStorage.setItem('alarmPatterns', JSON.stringify(data.alarmPatterns));
          }
          
          if (data.settings) {
            localStorage.setItem('settings', JSON.stringify(data.settings));
          }

          alert('データをインポートしました');
          window.location.reload();
        } catch (error) {
          alert('データのインポートに失敗しました');
        }
      };
      reader.readAsText(file);
    }

    // データの削除
    function clearData() {
      if (!confirm('すべてのデータを削除しますか?この操作は取り消せません。')) {
        return;
      }

      localStorage.removeItem('alarmPatterns');
      localStorage.removeItem('settings');
      sessionStorage.clear();

      alert('すべてのデータを削除しました');
      window.location.reload();
    }

    // イベントリスナー設定
    document.getElementById('sound-enabled')?.addEventListener('change', saveSettings);
    document.getElementById('notification-enabled')?.addEventListener('change', saveSettings);
    document.getElementById('location-enabled')?.addEventListener('change', saveSettings);

    document.getElementById('export-data')?.addEventListener('click', exportData);

    document.getElementById('import-data')?.addEventListener('click', () => {
      document.getElementById('import-file')?.click();
    });

    document.getElementById('import-file')?.addEventListener('change', (e) => {
      const file = (e.target as HTMLInputElement).files?.[0];
      if (file) {
        importData(file);
      }
    });

    document.getElementById('clear-data')?.addEventListener('click', clearData);

    // 初期化
    loadSettings();
  </script>
</Layout>
