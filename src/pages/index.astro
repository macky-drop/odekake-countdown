---
import Layout from '../layouts/Layout.astro';
---

<Layout title="ãŠã§ã‹ã‘ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã‚¢ãƒ—ãƒª" activeTab="home">
  <div class="home-container">
    <!-- 1æ®µç›®: æ—¥ä»˜ãƒ»æ™‚åˆ»è¡¨ç¤º -->
    <div class="card datetime-card">
      <div class="date" id="current-date">2026å¹´1æœˆ2æ—¥ (Thu)</div>
      <div class="time-display">
        <span class="time-hm" id="current-time-hm">00:00</span>
        <span class="time-s" id="current-time-s">:00</span>
      </div>
    </div>

    <!-- 2æ®µç›®: ã‚¢ãƒ©ãƒ¼ãƒ çŠ¶æ³ -->
    <div class="card alarm-status" id="alarm-status">
      <h2 class="section-title">ã‚¢ãƒ©ãƒ¼ãƒ </h2>
      <div id="alarm-info" class="alarm-info">
        <p class="no-alarm">æœªè¨­å®š</p>
      </div>
    </div>

    <!-- 3æ®µç›®: ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³è¡¨ç¤º -->
    <div class="card countdown-card" id="countdown-card" style="display: none;">
      <h2 class="section-title">ãŠã§ã‹ã‘ã¾ã§</h2>
      <div class="countdown-display">
        <div class="countdown-time" id="countdown-time">00:00:00</div>
      </div>
    </div>

    <!-- 4æ®µç›®: å¤©æ°—æƒ…å ± -->
    <div class="card weather-card">
      <h2 class="section-title">å¤©æ°—æƒ…å ±</h2>
      <div id="weather-info" class="weather-info">
        <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
      <div class="location-selector">
        <select id="location-select" class="location-select">
          <option value="gps">ç¾åœ¨åœ° (GPS)</option>
          <option value="35.6762,139.6503">æ±äº¬</option>
          <option value="34.6937,135.5023">å¤§é˜ª</option>
          <option value="35.0116,135.7681">äº¬éƒ½</option>
          <option value="35.4437,139.6380">æ¨ªæµœ</option>
          <option value="43.0642,141.3469">æœ­å¹Œ</option>
          <option value="33.5904,130.4017">ç¦å²¡</option>
          <option value="26.2124,127.6809">é‚£è¦‡</option>
        </select>
      </div>
    </div>
  </div>

  <style>
    .home-container {
      max-width: 600px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .card {
      padding: 1rem;
    }

    /* 1æ®µç›®: æ—¥ä»˜ãƒ»æ™‚åˆ» */
    .datetime-card {
      text-align: center;
      background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
      color: white;
    }

    .date {
      font-size: 1rem;
      font-weight: 500;
      margin-bottom: 0.5rem;
    }

    .time-display {
      display: flex;
      justify-content: center;
      align-items: baseline;
      font-variant-numeric: tabular-nums;
    }

    .time-hm {
      font-size: 3rem;
      font-weight: 700;
      line-height: 1;
    }

    .time-s {
      font-size: 1.5rem;
      font-weight: 600;
      margin-left: 0.1rem;
    }

    /* 2æ®µç›®: ã‚¢ãƒ©ãƒ¼ãƒ  */
    .alarm-status {
      cursor: pointer;
      transition: background 0.2s;
    }

    .alarm-status:hover {
      background: #f8fafc;
    }

    .section-title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 0.75rem;
      text-align: center;
    }

    .alarm-info {
      text-align: center;
    }

    .no-alarm {
      color: var(--color-text-secondary);
      font-size: 0.875rem;
      margin: 0;
    }

    .alarm-details {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      font-size: 0.875rem;
    }

    .alarm-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.4rem 0.75rem;
      background: var(--color-background);
      border-radius: 6px;
    }

    .alarm-label {
      font-weight: 600;
      color: var(--color-text-secondary);
      font-size: 0.8rem;
    }

    .alarm-time {
      font-size: 1rem;
      font-weight: 700;
      color: var(--color-primary);
    }

    /* 3æ®µç›®: ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ */
    .countdown-card {
      background: linear-gradient(135deg, var(--color-secondary) 0%, #059669 100%);
      color: white;
    }

    .countdown-display {
      text-align: center;
    }

    .countdown-time {
      font-size: 3rem;
      font-weight: 700;
      font-variant-numeric: tabular-nums;
      line-height: 1;
    }

    /* 4æ®µç›®: å¤©æ°— */
    .weather-info {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1rem;
      min-height: 60px;
    }

    .loading {
      color: var(--color-text-secondary);
      text-align: center;
      width: 100%;
    }

    .weather-display {
      display: flex;
      align-items: center;
      gap: 1rem;
      width: 100%;
      justify-content: center;
    }

    .weather-icon {
      font-size: 2.5rem;
    }

    .weather-details {
      text-align: left;
    }

    .weather-condition {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 0.25rem;
    }

    .weather-temp {
      font-size: 0.875rem;
      color: var(--color-text-secondary);
    }

    .location-selector {
      margin-top: 0.75rem;
    }

    .location-select {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid var(--color-border);
      border-radius: 6px;
      font-size: 0.875rem;
    }

    @media (max-width: 640px) {
      .home-container {
        gap: 0.5rem;
      }

      .card {
        padding: 0.75rem;
      }

      .time-hm {
        font-size: 2.5rem;
      }

      .time-s {
        font-size: 1.25rem;
      }

      .countdown-time {
        font-size: 2.5rem;
      }

      .section-title {
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
      }
    }
  </style>

  <script>
    import type { AlarmPattern, WeatherData } from '../types';

    const WEEKDAY_EN = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

    // ç¾åœ¨æ™‚åˆ»ã®æ›´æ–°
    function updateDateTime() {
      const now = new Date();
      const dateEl = document.getElementById('current-date');
      const timeHmEl = document.getElementById('current-time-hm');
      const timeSEl = document.getElementById('current-time-s');
      
      if (dateEl) {
        const year = now.getFullYear();
        const month = now.getMonth() + 1;
        const day = now.getDate();
        const weekday = WEEKDAY_EN[now.getDay()];
        dateEl.textContent = `${year}å¹´${month}æœˆ${day}æ—¥ (${weekday})`;
      }
      
      if (timeHmEl && timeSEl) {
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const seconds = String(now.getSeconds()).padStart(2, '0');
        timeHmEl.textContent = `${hours}:${minutes}`;
        timeSEl.textContent = `:${seconds}`;
      }
    }

    // ã‚¢ãƒ©ãƒ¼ãƒ æƒ…å ±ã®è¡¨ç¤º
    function displayAlarmInfo() {
      const alarmInfoEl = document.getElementById('alarm-info');
      if (!alarmInfoEl) return;

      const stored = localStorage.getItem('alarmPatterns');
      if (!stored) {
        alarmInfoEl.innerHTML = '<p class="no-alarm">æœªè¨­å®š</p>';
        return;
      }

      const patterns: AlarmPattern[] = JSON.parse(stored);
      const activePattern = patterns.find(p => p.isActive);

      if (!activePattern) {
        alarmInfoEl.innerHTML = '<p class="no-alarm">æœªè¨­å®š</p>';
        return;
      }

      const wakeTimeDisplay = activePattern.wakeUpTime || 'OFF';
      
      alarmInfoEl.innerHTML = `
        <div class="alarm-details">
          <div class="alarm-item">
            <span class="alarm-label">ãƒ‘ã‚¿ãƒ¼ãƒ³</span>
            <span>${activePattern.label}</span>
          </div>
          <div class="alarm-item">
            <span class="alarm-label">ã‚ã–ã¾ã—</span>
            <span class="alarm-time">${wakeTimeDisplay}</span>
          </div>
          <div class="alarm-item">
            <span class="alarm-label">ãŠã§ã‹ã‘</span>
            <span class="alarm-time">${activePattern.departureTime}</span>
          </div>
        </div>
      `;

      updateCountdown(activePattern);
    }

    // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã®æ›´æ–°
    function updateCountdown(pattern: AlarmPattern) {
      const countdownCard = document.getElementById('countdown-card');
      const countdownTime = document.getElementById('countdown-time');
      if (!countdownCard || !countdownTime) return;

      const now = new Date();
      const [hours, minutes] = pattern.departureTime.split(':').map(Number);
      const target = new Date(now);
      target.setHours(hours, minutes, 0, 0);

      // ä»Šæ—¥ã®ãŠã§ã‹ã‘æ™‚åˆ»ãŒéãã¦ã„ãŸã‚‰ç¿Œæ—¥ã«è¨­å®š
      if (target <= now) {
        target.setDate(target.getDate() + 1);
      }

      const diff = target.getTime() - now.getTime();
      
      // ãŠã§ã‹ã‘æ™‚åˆ»ã‚’éããŸå ´åˆï¼ˆdiff <= 0ï¼‰
      if (diff <= 0) {
        checkAndNotify(0);
        countdownCard.style.display = 'none';
        // ç¿Œæ—¥ã®ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã‚’é–‹å§‹ã™ã‚‹ãŸã‚ã€æ¬¡ã®æ›´æ–°ã§å†è¨ˆç®—ã•ã‚Œã‚‹
        return;
      }

      const hours_left = Math.floor(diff / (1000 * 60 * 60));
      const minutes_left = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      const seconds_left = Math.floor((diff % (1000 * 60)) / 1000);

      countdownTime.textContent = `${String(hours_left).padStart(2, '0')}:${String(minutes_left).padStart(2, '0')}:${String(seconds_left).padStart(2, '0')}`;
      countdownCard.style.display = 'block';

      // é€šçŸ¥ãƒã‚§ãƒƒã‚¯ï¼ˆæ­£ç¢ºãªã‚¿ã‚¤ãƒŸãƒ³ã‚°ï¼‰
      const totalSeconds = Math.floor(diff / 1000);
      
      // 00:00:00ã«ãªã£ãŸç¬é–“ï¼ˆtotalSeconds === 0ï¼‰
      if (totalSeconds === 0) {
        checkAndNotify(0);
        return;
      }
      
      // å„é€šçŸ¥é–“éš”ã«å¯¾ã—ã¦ã€ã¡ã‚‡ã†ã©ãã®æ™‚åˆ»ã«ãªã£ãŸã‚‰é€šçŸ¥
      pattern.notificationIntervals.forEach(interval => {
        const targetSeconds = interval * 60;
        // targetSecondsã¡ã‚‡ã†ã©ã€ã¾ãŸã¯targetSeconds-1ç§’ã®æ™‚ã«é€šçŸ¥
        if (totalSeconds === targetSeconds || totalSeconds === targetSeconds - 1) {
          checkAndNotify(interval);
        }
      });
    }

    // é€šçŸ¥å‡¦ç†
    function checkAndNotify(minutesLeft: number) {
      const lastNotified = sessionStorage.getItem(`notified_${minutesLeft}`);
      if (lastNotified) return;

      sessionStorage.setItem(`notified_${minutesLeft}`, 'true');

      const settings = JSON.parse(localStorage.getItem('settings') || '{"soundEnabled":true}');
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);

      if (minutesLeft === 0) {
        // ãŠã§ã‹ã‘æ™‚åˆ»
        if (isIOS) {
          if (settings.soundEnabled && 'speechSynthesis' in window) {
            const utterance = new SpeechSynthesisUtterance('ãŠã§ã‹ã‘ã®æ™‚é–“ã§ã™ï¼ã„ã£ã¦ã‚‰ã£ã—ã‚ƒã„ï¼');
            utterance.lang = 'ja-JP';
            utterance.volume = 1.0;
            speechSynthesis.speak(utterance);
          }
          showVisualAlert('ğŸš¶ ãŠã§ã‹ã‘ã®æ™‚é–“ã§ã™ï¼', 'ã„ã£ã¦ã‚‰ã£ã—ã‚ƒã„ï¼');
        } else {
          if ('Notification' in window && Notification.permission === 'granted') {
            new Notification('ãŠã§ã‹ã‘ã®æ™‚é–“ã§ã™ï¼', {
              body: 'ã„ã£ã¦ã‚‰ã£ã—ã‚ƒã„ï¼',
              icon: '/favicon.svg',
              tag: 'departure-alarm',
              requireInteraction: true,
              vibrate: [200, 100, 200]
            });
          }
          if (settings.soundEnabled && 'speechSynthesis' in window) {
            const utterance = new SpeechSynthesisUtterance('ãŠã§ã‹ã‘ã®æ™‚é–“ã§ã™');
            utterance.lang = 'ja-JP';
            speechSynthesis.speak(utterance);
          }
        }
      } else {
        // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³é€šçŸ¥
        if (settings.soundEnabled && 'speechSynthesis' in window) {
          const utterance = new SpeechSynthesisUtterance(`ãŠã§ã‹ã‘${minutesLeft}åˆ†å‰ã§ã™`);
          utterance.lang = 'ja-JP';
          speechSynthesis.speak(utterance);
        }

        if (isIOS) {
          showVisualAlert('â° ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³', `ãŠã§ã‹ã‘${minutesLeft}åˆ†å‰ã§ã™`, 3000);
        } else {
          if ('Notification' in window && Notification.permission === 'granted') {
            new Notification('ãŠã§ã‹ã‘ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³', {
              body: `ãŠã§ã‹ã‘${minutesLeft}åˆ†å‰ã§ã™`,
              icon: '/favicon.svg',
              tag: `countdown-${minutesLeft}`
            });
          }
        }
      }
    }

    // ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤ºï¼ˆiOSç”¨ï¼‰
    function showVisualAlert(title: string, message: string, duration: number = 0) {
      const existing = document.getElementById('visual-alert');
      if (existing) existing.remove();

      const alert = document.createElement('div');
      alert.id = 'visual-alert';
      alert.innerHTML = `
        <div style="
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: white;
          padding: 2rem;
          border-radius: 16px;
          box-shadow: 0 20px 60px rgba(0,0,0,0.3);
          z-index: 10000;
          text-align: center;
          min-width: 280px;
          max-width: 90vw;
          animation: slideIn 0.3s ease-out;
        ">
          <div style="font-size: 3rem; margin-bottom: 1rem;">${title.split(' ')[0]}</div>
          <div style="font-size: 1.5rem; font-weight: bold; margin-bottom: 0.5rem;">${title.split(' ').slice(1).join(' ')}</div>
          <div style="font-size: 1rem; color: #666;">${message}</div>
          <button onclick="this.closest('#visual-alert').remove()" style="
            margin-top: 1.5rem;
            padding: 0.75rem 2rem;
            background: var(--color-primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
          ">ç¢ºèª</button>
        </div>
        <div onclick="this.closest('#visual-alert').remove()" style="
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0,0,0,0.5);
          z-index: 9999;
        "></div>
        <style>
          @keyframes slideIn {
            from {
              opacity: 0;
              transform: translate(-50%, -60%);
            }
            to {
              opacity: 1;
              transform: translate(-50%, -50%);
            }
          }
        </style>
      `;
      document.body.appendChild(alert);

      if (duration > 0) {
        setTimeout(() => {
          alert.remove();
        }, duration);
      }
    }

    // å¤©æ°—æƒ…å ±ã®å–å¾—ï¼ˆOpen-Meteoï¼‰
    async function fetchWeather() {
      const weatherInfoEl = document.getElementById('weather-info');
      const locationSelect = document.getElementById('location-select') as HTMLSelectElement;
      if (!weatherInfoEl) return;

      try {
        let lat: number, lon: number;

        if (locationSelect.value === 'gps') {
          if (!('geolocation' in navigator)) {
            throw new Error('ä½ç½®æƒ…å ±ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
          }

          const position = await new Promise<GeolocationPosition>((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(resolve, reject);
          });

          lat = position.coords.latitude;
          lon = position.coords.longitude;
        } else {
          [lat, lon] = locationSelect.value.split(',').map(Number);
        }

        // Open-Meteo API
        const response = await fetch(
          `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code&daily=temperature_2m_max,temperature_2m_min&timezone=Asia/Tokyo`
        );

        if (!response.ok) throw new Error('å¤©æ°—æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');

        const data = await response.json();
        
        // å¤©æ°—ã‚³ãƒ¼ãƒ‰ã‚’ã‚¢ã‚¤ã‚³ãƒ³ã«å¤‰æ›
        const weatherCode = data.current.weather_code;
        const weatherIcon = getWeatherIcon(weatherCode);
        const weatherDesc = getWeatherDescription(weatherCode);
        
        const currentTemp = Math.round(data.current.temperature_2m);
        const maxTemp = Math.round(data.daily.temperature_2m_max[0]);
        const minTemp = Math.round(data.daily.temperature_2m_min[0]);

        weatherInfoEl.innerHTML = `
          <div class="weather-display">
            <div class="weather-icon">${weatherIcon}</div>
            <div class="weather-details">
              <div class="weather-condition">${weatherDesc}</div>
              <div class="weather-temp">ç¾åœ¨: ${currentTemp}â„ƒ</div>
              <div class="weather-temp">æœ€é«˜: ${maxTemp}â„ƒ / æœ€ä½: ${minTemp}â„ƒ</div>
            </div>
          </div>
        `;
      } catch (error) {
        weatherInfoEl.innerHTML = `
          <div class="weather-display">
            <div class="weather-details">
              <div class="weather-condition">å¤©æ°—æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ</div>
            </div>
          </div>
        `;
      }
    }

    // å¤©æ°—ã‚³ãƒ¼ãƒ‰ã‹ã‚‰ã‚¢ã‚¤ã‚³ãƒ³ã‚’å–å¾—
    function getWeatherIcon(code: number): string {
      if (code === 0) return 'â˜€ï¸';
      if (code <= 3) return 'â›…';
      if (code <= 48) return 'ğŸŒ«ï¸';
      if (code <= 67) return 'ğŸŒ§ï¸';
      if (code <= 77) return 'ğŸŒ¨ï¸';
      if (code <= 82) return 'ğŸŒ§ï¸';
      if (code <= 86) return 'ğŸŒ¨ï¸';
      return 'â›ˆï¸';
    }

    // å¤©æ°—ã‚³ãƒ¼ãƒ‰ã‹ã‚‰èª¬æ˜ã‚’å–å¾—
    function getWeatherDescription(code: number): string {
      if (code === 0) return 'å¿«æ™´';
      if (code === 1) return 'æ™´ã‚Œ';
      if (code === 2) return 'ä¸€éƒ¨æ›‡ã‚Š';
      if (code === 3) return 'æ›‡ã‚Š';
      if (code <= 48) return 'éœ§';
      if (code <= 67) return 'é›¨';
      if (code <= 77) return 'é›ª';
      if (code <= 82) return 'å¼·ã„é›¨';
      if (code <= 86) return 'å¼·ã„é›ª';
      return 'é›·é›¨';
    }

    // ã‚¢ãƒ©ãƒ¼ãƒ è¨­å®šã‚¨ãƒªã‚¢ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
    const alarmStatus = document.getElementById('alarm-status');
    if (alarmStatus) {
      alarmStatus.addEventListener('click', () => {
        window.location.href = '/alarms';
      });
    }

    // åœ°åŸŸé¸æŠã®å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆ
    const locationSelect = document.getElementById('location-select');
    if (locationSelect) {
      locationSelect.addEventListener('change', fetchWeather);
    }

    // åˆæœŸåŒ–
    updateDateTime();
    displayAlarmInfo();
    fetchWeather();

    // é€šçŸ¥è¨±å¯ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    if ('Notification' in window && Notification.permission === 'default') {
      Notification.requestPermission();
    }

    // å®šæœŸæ›´æ–°
    setInterval(() => {
      updateDateTime();
      const stored = localStorage.getItem('alarmPatterns');
      if (stored) {
        const patterns: AlarmPattern[] = JSON.parse(stored);
        const activePattern = patterns.find(p => p.isActive);
        if (activePattern) {
          updateCountdown(activePattern);
        }
      }
    }, 1000);
  </script>
</Layout>
