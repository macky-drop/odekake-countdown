---
import Layout from '../layouts/Layout.astro';
---

<Layout title="ãŠã§ã‹ã‘ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã‚¢ãƒ—ãƒª" activeTab="home">
  <div class="home-container">
    <h1 class="app-title">ãŠã§ã‹ã‘ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³</h1>
    
    <!-- æ—¥ä»˜ãƒ»æ™‚åˆ»è¡¨ç¤º -->
    <div class="card datetime-card">
      <div class="date" id="current-date">2026å¹´1æœˆ2æ—¥</div>
      <div class="time" id="current-time">00:00:00</div>
    </div>

    <!-- ã‚¢ãƒ©ãƒ¼ãƒ çŠ¶æ³ -->
    <div class="card alarm-status" id="alarm-status">
      <h2 class="section-title">ã‚¢ãƒ©ãƒ¼ãƒ è¨­å®šçŠ¶æ³</h2>
      <div id="alarm-info" class="alarm-info">
        <p class="no-alarm">ã‚¢ãƒ©ãƒ¼ãƒ ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
      </div>
    </div>

    <!-- ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³è¡¨ç¤º -->
    <div class="card countdown-card" id="countdown-card" style="display: none;">
      <h2 class="section-title">ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³</h2>
      <div class="countdown-display" id="countdown-display">
        <div class="countdown-time">--:--:--</div>
        <div class="countdown-label">ãŠã§ã‹ã‘ã¾ã§</div>
      </div>
    </div>

    <!-- å¤©æ°—æƒ…å ± -->
    <div class="card weather-card">
      <h2 class="section-title">ç¾åœ¨åœ°ã®å¤©æ°—</h2>
      <div id="weather-info" class="weather-info">
        <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
    </div>

    <!-- ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰ -->
    <div class="card">
      <h2 class="section-title">é€šçŸ¥ãƒ†ã‚¹ãƒˆ</h2>
      <button class="btn btn-secondary btn-full" id="check-permission">é€šçŸ¥è¨±å¯çŠ¶æ…‹ã‚’ç¢ºèª</button>
      <button class="btn btn-secondary btn-full" id="test-notification">é€šçŸ¥ã‚’ãƒ†ã‚¹ãƒˆ</button>
      <button class="btn btn-secondary btn-full" id="test-speech">éŸ³å£°ã‚’ãƒ†ã‚¹ãƒˆ</button>
      <div id="test-result" style="margin-top: 1rem; padding: 0.75rem; background: #f0f0f0; border-radius: 6px; display: none;"></div>
    </div>
  </div>

  <style>
    .home-container {
      max-width: 600px;
      margin: 0 auto;
    }

    .app-title {
      font-size: 1.75rem;
      font-weight: 700;
      margin-bottom: 1.5rem;
      color: var(--color-primary);
      text-align: center;
    }

    .datetime-card {
      text-align: center;
      background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
      color: white;
    }

    .date {
      font-size: 1.125rem;
      font-weight: 500;
      margin-bottom: 0.5rem;
    }

    .time {
      font-size: 2.5rem;
      font-weight: 700;
      font-variant-numeric: tabular-nums;
    }

    .section-title {
      font-size: 1.125rem;
      font-weight: 600;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .alarm-info {
      cursor: pointer;
      transition: background 0.2s;
      padding: 1rem;
      border-radius: 8px;
    }

    .alarm-info:hover {
      background: var(--color-background);
    }

    .no-alarm {
      color: var(--color-text-secondary);
      text-align: center;
    }

    .alarm-details {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .alarm-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem;
      background: var(--color-background);
      border-radius: 6px;
    }

    .alarm-label {
      font-weight: 600;
      color: var(--color-text);
    }

    .alarm-time {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--color-primary);
    }

    .countdown-card {
      background: linear-gradient(135deg, var(--color-secondary) 0%, #059669 100%);
      color: white;
    }

    .countdown-display {
      text-align: center;
    }

    .countdown-time {
      font-size: 3rem;
      font-weight: 700;
      font-variant-numeric: tabular-nums;
      margin-bottom: 0.5rem;
    }

    .countdown-label {
      font-size: 1.125rem;
      opacity: 0.9;
    }

    .weather-info {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .loading {
      color: var(--color-text-secondary);
      text-align: center;
      width: 100%;
    }

    .weather-display {
      display: flex;
      align-items: center;
      gap: 1.5rem;
      width: 100%;
    }

    .weather-icon {
      font-size: 3rem;
    }

    .weather-details {
      flex: 1;
    }

    .weather-temp {
      font-size: 2rem;
      font-weight: 700;
      color: var(--color-primary);
    }

    .weather-desc {
      color: var(--color-text-secondary);
      margin-top: 0.25rem;
    }

    .btn-full {
      width: 100%;
      margin-bottom: 0.5rem;
    }

    @media (max-width: 640px) {
      .app-title {
        font-size: 1.5rem;
      }

      .time {
        font-size: 2rem;
      }

      .countdown-time {
        font-size: 2.5rem;
      }
    }
  </style>

  <script>
    import type { AlarmPattern, WeatherData } from '../types';

    // ç¾åœ¨æ™‚åˆ»ã®æ›´æ–°
    function updateDateTime() {
      const now = new Date();
      const dateEl = document.getElementById('current-date');
      const timeEl = document.getElementById('current-time');
      
      if (dateEl) {
        dateEl.textContent = now.toLocaleDateString('ja-JP', {
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
      }
      
      if (timeEl) {
        timeEl.textContent = now.toLocaleTimeString('ja-JP', {
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit'
        });
      }
    }

    // ã‚¢ãƒ©ãƒ¼ãƒ æƒ…å ±ã®è¡¨ç¤º
    function displayAlarmInfo() {
      const alarmInfoEl = document.getElementById('alarm-info');
      if (!alarmInfoEl) return;

      const stored = localStorage.getItem('alarmPatterns');
      if (!stored) {
        alarmInfoEl.innerHTML = '<p class="no-alarm">ã‚¢ãƒ©ãƒ¼ãƒ ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</p>';
        return;
      }

      const patterns: AlarmPattern[] = JSON.parse(stored);
      const activePattern = patterns.find(p => p.isActive);

      if (!activePattern) {
        alarmInfoEl.innerHTML = '<p class="no-alarm">ã‚¢ãƒ©ãƒ¼ãƒ ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</p>';
        return;
      }

      alarmInfoEl.innerHTML = `
        <div class="alarm-details">
          <div class="alarm-item">
            <span class="alarm-label">ãƒ‘ã‚¿ãƒ¼ãƒ³</span>
            <span>${activePattern.label}</span>
          </div>
          <div class="alarm-item">
            <span class="alarm-label">ã‚ã–ã¾ã—</span>
            <span class="alarm-time">${activePattern.wakeUpTime}</span>
          </div>
          <div class="alarm-item">
            <span class="alarm-label">ãŠã§ã‹ã‘</span>
            <span class="alarm-time">${activePattern.departureTime}</span>
          </div>
        </div>
      `;

      // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã®æ›´æ–°
      updateCountdown(activePattern);
    }

    // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã®æ›´æ–°
    function updateCountdown(pattern: AlarmPattern) {
      const countdownCard = document.getElementById('countdown-card');
      const countdownDisplay = document.getElementById('countdown-display');
      if (!countdownCard || !countdownDisplay) return;

      const now = new Date();
      const [hours, minutes] = pattern.departureTime.split(':').map(Number);
      const target = new Date(now);
      target.setHours(hours, minutes, 0, 0);

      // ç¿Œæ—¥ã®åˆ¤å®š
      if (target < now) {
        target.setDate(target.getDate() + 1);
      }

      const diff = target.getTime() - now.getTime();
      
      if (diff <= 0) {
        // ãŠã§ã‹ã‘æ™‚åˆ»ã«ãªã£ãŸ
        checkAndNotify(0); // 0åˆ† = ãŠã§ã‹ã‘æ™‚åˆ»
        countdownCard.style.display = 'none';
        return;
      }

      const hours_left = Math.floor(diff / (1000 * 60 * 60));
      const minutes_left = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      const seconds_left = Math.floor((diff % (1000 * 60)) / 1000);

      countdownDisplay.innerHTML = `
        <div class="countdown-time">${String(hours_left).padStart(2, '0')}:${String(minutes_left).padStart(2, '0')}:${String(seconds_left).padStart(2, '0')}</div>
        <div class="countdown-label">ãŠã§ã‹ã‘ã¾ã§</div>
      `;
      
      countdownCard.style.display = 'block';

      // é€šçŸ¥ãƒã‚§ãƒƒã‚¯ï¼ˆç§’æ•°ã‚’è€ƒæ…®ã—ã¦æ­£ç¢ºãªã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§é€šçŸ¥ï¼‰
      // ä¾‹: 1åˆ†å‰ = æ®‹ã‚Š60ç§’ï½59ç§’ã®é–“ã«1å›ã ã‘é€šçŸ¥
      const totalSeconds = Math.floor(diff / 1000);
      const totalMinutes = Math.floor(totalSeconds / 60);
      
      if (pattern.notificationIntervals.includes(totalMinutes) && seconds_left >= 59) {
        // 59ç§’ä»¥ä¸Šã®æ™‚ã ã‘é€šçŸ¥ï¼ˆã¡ã‚‡ã†ã©â—¯åˆ†00ç§’ï½â—¯åˆ†01ç§’ã®é–“ï¼‰
        checkAndNotify(totalMinutes);
      }
    }

    // é€šçŸ¥å‡¦ç†
    function checkAndNotify(minutesLeft: number) {
      const lastNotified = sessionStorage.getItem(`notified_${minutesLeft}`);
      if (lastNotified) return;

      sessionStorage.setItem(`notified_${minutesLeft}`, 'true');

      const settings = JSON.parse(localStorage.getItem('settings') || '{"soundEnabled":true}');

      // iOSåˆ¤å®š
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);

      if (minutesLeft === 0) {
        // ãŠã§ã‹ã‘æ™‚åˆ»
        if (isIOS) {
          // iOS: éŸ³å£° + ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ã‚¢ãƒ©ãƒ¼ãƒˆ
          if (settings.soundEnabled && 'speechSynthesis' in window) {
            const utterance = new SpeechSynthesisUtterance('ãŠã§ã‹ã‘ã®æ™‚é–“ã§ã™ï¼ã„ã£ã¦ã‚‰ã£ã—ã‚ƒã„ï¼');
            utterance.lang = 'ja-JP';
            utterance.volume = 1.0;
            speechSynthesis.speak(utterance);
          }
          // å…¨ç”»é¢ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤º
          showVisualAlert('ğŸš¶ ãŠã§ã‹ã‘ã®æ™‚é–“ã§ã™ï¼', 'ã„ã£ã¦ã‚‰ã£ã—ã‚ƒã„ï¼');
        } else {
          // PC/Android: ãƒ–ãƒ©ã‚¦ã‚¶é€šçŸ¥
          if ('Notification' in window && Notification.permission === 'granted') {
            new Notification('ãŠã§ã‹ã‘ã®æ™‚é–“ã§ã™ï¼', {
              body: 'ã„ã£ã¦ã‚‰ã£ã—ã‚ƒã„ï¼',
              icon: '/favicon.svg',
              tag: 'departure-alarm',
              requireInteraction: true,
              vibrate: [200, 100, 200]
            });
          }
          if (settings.soundEnabled && 'speechSynthesis' in window) {
            const utterance = new SpeechSynthesisUtterance('ãŠã§ã‹ã‘ã®æ™‚é–“ã§ã™');
            utterance.lang = 'ja-JP';
            speechSynthesis.speak(utterance);
          }
        }
      } else {
        // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³é€šçŸ¥
        if (settings.soundEnabled && 'speechSynthesis' in window) {
          const utterance = new SpeechSynthesisUtterance(`ãŠã§ã‹ã‘${minutesLeft}åˆ†å‰ã§ã™`);
          utterance.lang = 'ja-JP';
          speechSynthesis.speak(utterance);
        }

        if (isIOS) {
          // iOS: ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ã‚¢ãƒ©ãƒ¼ãƒˆï¼ˆæ§ãˆã‚ï¼‰
          showVisualAlert('â° ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³', `ãŠã§ã‹ã‘${minutesLeft}åˆ†å‰ã§ã™`, 3000);
        } else {
          // PC/Android: ãƒ–ãƒ©ã‚¦ã‚¶é€šçŸ¥
          if ('Notification' in window && Notification.permission === 'granted') {
            new Notification('ãŠã§ã‹ã‘ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³', {
              body: `ãŠã§ã‹ã‘${minutesLeft}åˆ†å‰ã§ã™`,
              icon: '/favicon.svg',
              tag: `countdown-${minutesLeft}`
            });
          }
        }
      }
    }

    // ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤ºï¼ˆiOSç”¨ï¼‰
    function showVisualAlert(title: string, message: string, duration: number = 0) {
      // æ—¢å­˜ã®ã‚¢ãƒ©ãƒ¼ãƒˆã‚’å‰Šé™¤
      const existing = document.getElementById('visual-alert');
      if (existing) existing.remove();

      const alert = document.createElement('div');
      alert.id = 'visual-alert';
      alert.innerHTML = `
        <div style="
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: white;
          padding: 2rem;
          border-radius: 16px;
          box-shadow: 0 20px 60px rgba(0,0,0,0.3);
          z-index: 10000;
          text-align: center;
          min-width: 280px;
          max-width: 90vw;
          animation: slideIn 0.3s ease-out;
        ">
          <div style="font-size: 3rem; margin-bottom: 1rem;">${title.split(' ')[0]}</div>
          <div style="font-size: 1.5rem; font-weight: bold; margin-bottom: 0.5rem;">${title.split(' ').slice(1).join(' ')}</div>
          <div style="font-size: 1rem; color: #666;">${message}</div>
          <button onclick="this.closest('#visual-alert').remove()" style="
            margin-top: 1.5rem;
            padding: 0.75rem 2rem;
            background: var(--color-primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
          ">ç¢ºèª</button>
        </div>
        <div onclick="this.closest('#visual-alert').remove()" style="
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0,0,0,0.5);
          z-index: 9999;
        "></div>
        <style>
          @keyframes slideIn {
            from {
              opacity: 0;
              transform: translate(-50%, -60%);
            }
            to {
              opacity: 1;
              transform: translate(-50%, -50%);
            }
          }
        </style>
      `;
      document.body.appendChild(alert);

      // è‡ªå‹•ã§é–‰ã˜ã‚‹ï¼ˆduration > 0ã®å ´åˆï¼‰
      if (duration > 0) {
        setTimeout(() => {
          alert.remove();
        }, duration);
      }
    }

    // å¤©æ°—æƒ…å ±ã®å–å¾—
    async function fetchWeather() {
      const weatherInfoEl = document.getElementById('weather-info');
      if (!weatherInfoEl) return;

      try {
        if (!('geolocation' in navigator)) {
          throw new Error('ä½ç½®æƒ…å ±ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
        }

        const position = await new Promise<GeolocationPosition>((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(resolve, reject);
        });

        const { latitude, longitude } = position.coords;
        
        // OpenWeatherMap APIã‚­ãƒ¼ã¯ç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–å¾—ï¼ˆæœ¬ç•ªç’°å¢ƒã§ã¯ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§å‡¦ç†ï¼‰
        // ã“ã“ã§ã¯ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
        const weatherData: WeatherData = {
          temp: 8,
          description: 'æ™´ã‚Œ',
          icon: 'â˜€ï¸'
        };

        weatherInfoEl.innerHTML = `
          <div class="weather-display">
            <div class="weather-icon">${weatherData.icon}</div>
            <div class="weather-details">
              <div class="weather-temp">${weatherData.temp}â„ƒ</div>
              <div class="weather-desc">${weatherData.description}</div>
            </div>
          </div>
        `;
      } catch (error) {
        weatherInfoEl.innerHTML = `
          <div class="weather-display">
            <div class="weather-details">
              <div class="weather-desc">å¤©æ°—æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ</div>
            </div>
          </div>
        `;
      }
    }

    // ã‚¢ãƒ©ãƒ¼ãƒ è¨­å®šã‚¨ãƒªã‚¢ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
    const alarmStatus = document.getElementById('alarm-status');
    if (alarmStatus) {
      alarmStatus.addEventListener('click', () => {
        window.location.href = '/alarms';
      });
    }

    // ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    const testResult = document.getElementById('test-result');

    // é€šçŸ¥è¨±å¯çŠ¶æ…‹ã®ç¢ºèª
    document.getElementById('check-permission')?.addEventListener('click', () => {
      if (!testResult) return;
      testResult.style.display = 'block';

      if (!('Notification' in window)) {
        testResult.innerHTML = `
          <strong>âŒ é€šçŸ¥éå¯¾å¿œ</strong><br>
          ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯é€šçŸ¥APIã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚<br>
          <small>ãƒ–ãƒ©ã‚¦ã‚¶: ${navigator.userAgent}</small>
        `;
        testResult.style.background = '#fee';
        return;
      }

      const permission = Notification.permission;
      let message = '';
      let bgColor = '';

      switch (permission) {
        case 'granted':
          message = `
            <strong>âœ… é€šçŸ¥ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã™</strong><br>
            ç¾åœ¨ã®çŠ¶æ…‹: ${permission}<br>
            é€šçŸ¥ã¯æ­£å¸¸ã«å‹•ä½œã™ã‚‹ã¯ãšã§ã™ã€‚
          `;
          bgColor = '#d1fae5';
          break;
        case 'denied':
          message = `
            <strong>âŒ é€šçŸ¥ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™</strong><br>
            ç¾åœ¨ã®çŠ¶æ…‹: ${permission}<br>
            <br>
            <strong>è§£æ±ºæ–¹æ³•:</strong><br>
            1. ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼å·¦ã®ğŸ”’ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯<br>
            2. ã€Œé€šçŸ¥ã€ã‚’ã€Œè¨±å¯ã€ã«å¤‰æ›´<br>
            3. ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰
          `;
          bgColor = '#fee';
          break;
        case 'default':
          message = `
            <strong>ğŸ“‹ é€šçŸ¥è¨±å¯ãŒæœªè¨­å®š</strong><br>
            ç¾åœ¨ã®çŠ¶æ…‹: ${permission}<br>
            ã€Œé€šçŸ¥ã‚’ãƒ†ã‚¹ãƒˆã€ãƒœã‚¿ãƒ³ã§è¨±å¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
          `;
          bgColor = '#fffbeb';
          break;
      }

      testResult.innerHTML = message;
      testResult.style.background = bgColor;
    });

    document.getElementById('test-notification')?.addEventListener('click', async () => {
      if (!testResult) return;
      testResult.style.display = 'block';

      // é€šçŸ¥è¨±å¯ã®ãƒã‚§ãƒƒã‚¯
      if (!('Notification' in window)) {
        testResult.textContent = 'âŒ ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯é€šçŸ¥ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“';
        testResult.style.background = '#fee';
        return;
      }

      if (Notification.permission === 'denied') {
        testResult.textContent = 'âŒ é€šçŸ¥ãŒæ‹’å¦ã•ã‚Œã¦ã„ã¾ã™ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‹ã‚‰è¨±å¯ã—ã¦ãã ã•ã„';
        testResult.style.background = '#fee';
        return;
      }

      if (Notification.permission === 'default') {
        testResult.textContent = 'ğŸ“‹ é€šçŸ¥è¨±å¯ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸­...';
        testResult.style.background = '#fffbeb';
        const permission = await Notification.requestPermission();
        if (permission !== 'granted') {
          testResult.textContent = 'âŒ é€šçŸ¥ãŒè¨±å¯ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ';
          testResult.style.background = '#fee';
          return;
        }
      }

      // é€šçŸ¥ã‚’é€ä¿¡
      try {
        const notification = new Notification('ãƒ†ã‚¹ãƒˆé€šçŸ¥', {
          body: 'ãŠã§ã‹ã‘ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã‚¢ãƒ—ãƒªã‹ã‚‰ã®ãƒ†ã‚¹ãƒˆé€šçŸ¥ã§ã™',
          icon: '/favicon.svg',
          tag: 'test-notification',
          requireInteraction: false,
          vibrate: [200, 100, 200]
        });

        testResult.textContent = 'âœ… é€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼é€šçŸ¥ãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸã‹ï¼Ÿ';
        testResult.style.background = '#d1fae5';

        notification.onclick = () => {
          testResult.textContent = 'âœ… é€šçŸ¥ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸï¼';
        };
      } catch (error) {
        testResult.textContent = `âŒ ã‚¨ãƒ©ãƒ¼: ${error}`;
        testResult.style.background = '#fee';
      }
    });

    document.getElementById('test-speech')?.addEventListener('click', () => {
      if (!testResult) return;
      testResult.style.display = 'block';

      if (!('speechSynthesis' in window)) {
        testResult.textContent = 'âŒ ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°åˆæˆã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“';
        testResult.style.background = '#fee';
        return;
      }

      try {
        const utterance = new SpeechSynthesisUtterance('ãŠã§ã‹ã‘1åˆ†å‰ã§ã™');
        utterance.lang = 'ja-JP';
        utterance.rate = 1.0;
        utterance.pitch = 1.0;
        utterance.volume = 1.0;

        utterance.onstart = () => {
          testResult.textContent = 'ğŸ”Š éŸ³å£°ã‚’å†ç”Ÿä¸­...';
          testResult.style.background = '#dbeafe';
        };

        utterance.onend = () => {
          testResult.textContent = 'âœ… éŸ³å£°å†ç”ŸãŒå®Œäº†ã—ã¾ã—ãŸï¼èã“ãˆã¾ã—ãŸã‹ï¼Ÿ';
          testResult.style.background = '#d1fae5';
        };

        utterance.onerror = (event) => {
          testResult.textContent = `âŒ éŸ³å£°ã‚¨ãƒ©ãƒ¼: ${event.error}`;
          testResult.style.background = '#fee';
        };

        speechSynthesis.speak(utterance);
      } catch (error) {
        testResult.textContent = `âŒ ã‚¨ãƒ©ãƒ¼: ${error}`;
        testResult.style.background = '#fee';
      }
    });

    // åˆæœŸåŒ–
    updateDateTime();
    displayAlarmInfo();
    fetchWeather();

    // é€šçŸ¥è¨±å¯ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    if ('Notification' in window && Notification.permission === 'default') {
      Notification.requestPermission();
    }

    // å®šæœŸæ›´æ–°
    setInterval(() => {
      updateDateTime();
      const stored = localStorage.getItem('alarmPatterns');
      if (stored) {
        const patterns: AlarmPattern[] = JSON.parse(stored);
        const activePattern = patterns.find(p => p.isActive);
        if (activePattern) {
          updateCountdown(activePattern);
        }
      }
    }, 1000);
  </script>
</Layout>
