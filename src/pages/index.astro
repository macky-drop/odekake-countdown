---
import Layout from '../layouts/Layout.astro';
---

<Layout title="おでかけカウントダウンアプリ" activeTab="home">
  <div class="home-container">
    <h1 class="app-title">おでかけカウントダウン</h1>
    
    <!-- 日付・時刻表示 -->
    <div class="card datetime-card">
      <div class="date" id="current-date">2026年1月2日</div>
      <div class="time" id="current-time">00:00:00</div>
    </div>

    <!-- アラーム状況 -->
    <div class="card alarm-status" id="alarm-status">
      <h2 class="section-title">アラーム設定状況</h2>
      <div id="alarm-info" class="alarm-info">
        <p class="no-alarm">アラームが設定されていません</p>
      </div>
    </div>

    <!-- カウントダウン表示 -->
    <div class="card countdown-card" id="countdown-card" style="display: none;">
      <h2 class="section-title">カウントダウン</h2>
      <div class="countdown-display" id="countdown-display">
        <div class="countdown-time">--:--:--</div>
        <div class="countdown-label">おでかけまで</div>
      </div>
    </div>

    <!-- 天気情報 -->
    <div class="card weather-card">
      <h2 class="section-title">現在地の天気</h2>
      <div id="weather-info" class="weather-info">
        <div class="loading">読み込み中...</div>
      </div>
    </div>
  </div>

  <style>
    .home-container {
      max-width: 600px;
      margin: 0 auto;
    }

    .app-title {
      font-size: 1.75rem;
      font-weight: 700;
      margin-bottom: 1.5rem;
      color: var(--color-primary);
      text-align: center;
    }

    .datetime-card {
      text-align: center;
      background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
      color: white;
    }

    .date {
      font-size: 1.125rem;
      font-weight: 500;
      margin-bottom: 0.5rem;
    }

    .time {
      font-size: 2.5rem;
      font-weight: 700;
      font-variant-numeric: tabular-nums;
    }

    .section-title {
      font-size: 1.125rem;
      font-weight: 600;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .alarm-info {
      cursor: pointer;
      transition: background 0.2s;
      padding: 1rem;
      border-radius: 8px;
    }

    .alarm-info:hover {
      background: var(--color-background);
    }

    .no-alarm {
      color: var(--color-text-secondary);
      text-align: center;
    }

    .alarm-details {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .alarm-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem;
      background: var(--color-background);
      border-radius: 6px;
    }

    .alarm-label {
      font-weight: 600;
      color: var(--color-text);
    }

    .alarm-time {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--color-primary);
    }

    .countdown-card {
      background: linear-gradient(135deg, var(--color-secondary) 0%, #059669 100%);
      color: white;
    }

    .countdown-display {
      text-align: center;
    }

    .countdown-time {
      font-size: 3rem;
      font-weight: 700;
      font-variant-numeric: tabular-nums;
      margin-bottom: 0.5rem;
    }

    .countdown-label {
      font-size: 1.125rem;
      opacity: 0.9;
    }

    .weather-info {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .loading {
      color: var(--color-text-secondary);
      text-align: center;
      width: 100%;
    }

    .weather-display {
      display: flex;
      align-items: center;
      gap: 1.5rem;
      width: 100%;
    }

    .weather-icon {
      font-size: 3rem;
    }

    .weather-details {
      flex: 1;
    }

    .weather-temp {
      font-size: 2rem;
      font-weight: 700;
      color: var(--color-primary);
    }

    .weather-desc {
      color: var(--color-text-secondary);
      margin-top: 0.25rem;
    }

    @media (max-width: 640px) {
      .app-title {
        font-size: 1.5rem;
      }

      .time {
        font-size: 2rem;
      }

      .countdown-time {
        font-size: 2.5rem;
      }
    }
  </style>

  <script>
    import type { AlarmPattern, WeatherData } from '../types';

    // 現在時刻の更新
    function updateDateTime() {
      const now = new Date();
      const dateEl = document.getElementById('current-date');
      const timeEl = document.getElementById('current-time');
      
      if (dateEl) {
        dateEl.textContent = now.toLocaleDateString('ja-JP', {
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
      }
      
      if (timeEl) {
        timeEl.textContent = now.toLocaleTimeString('ja-JP', {
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit'
        });
      }
    }

    // アラーム情報の表示
    function displayAlarmInfo() {
      const alarmInfoEl = document.getElementById('alarm-info');
      if (!alarmInfoEl) return;

      const stored = localStorage.getItem('alarmPatterns');
      if (!stored) {
        alarmInfoEl.innerHTML = '<p class="no-alarm">アラームが設定されていません</p>';
        return;
      }

      const patterns: AlarmPattern[] = JSON.parse(stored);
      const activePattern = patterns.find(p => p.isActive);

      if (!activePattern) {
        alarmInfoEl.innerHTML = '<p class="no-alarm">アラームが設定されていません</p>';
        return;
      }

      alarmInfoEl.innerHTML = `
        <div class="alarm-details">
          <div class="alarm-item">
            <span class="alarm-label">パターン</span>
            <span>${activePattern.label}</span>
          </div>
          <div class="alarm-item">
            <span class="alarm-label">めざまし</span>
            <span class="alarm-time">${activePattern.wakeUpTime}</span>
          </div>
          <div class="alarm-item">
            <span class="alarm-label">おでかけ</span>
            <span class="alarm-time">${activePattern.departureTime}</span>
          </div>
        </div>
      `;

      // カウントダウンの更新
      updateCountdown(activePattern);
    }

    // カウントダウンの更新
    function updateCountdown(pattern: AlarmPattern) {
      const countdownCard = document.getElementById('countdown-card');
      const countdownDisplay = document.getElementById('countdown-display');
      if (!countdownCard || !countdownDisplay) return;

      const now = new Date();
      const [hours, minutes] = pattern.departureTime.split(':').map(Number);
      const target = new Date(now);
      target.setHours(hours, minutes, 0, 0);

      // 翌日の判定
      if (target < now) {
        target.setDate(target.getDate() + 1);
      }

      const diff = target.getTime() - now.getTime();
      
      if (diff <= 0) {
        countdownCard.style.display = 'none';
        return;
      }

      const hours_left = Math.floor(diff / (1000 * 60 * 60));
      const minutes_left = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      const seconds_left = Math.floor((diff % (1000 * 60)) / 1000);

      countdownDisplay.innerHTML = `
        <div class="countdown-time">${String(hours_left).padStart(2, '0')}:${String(minutes_left).padStart(2, '0')}:${String(seconds_left).padStart(2, '0')}</div>
        <div class="countdown-label">おでかけまで</div>
      `;
      
      countdownCard.style.display = 'block';

      // 通知チェック
      const minutesLeft = Math.floor(diff / (1000 * 60));
      if (pattern.notificationIntervals.includes(minutesLeft)) {
        checkAndNotify(minutesLeft);
      }
    }

    // 通知処理
    function checkAndNotify(minutesLeft: number) {
      const lastNotified = sessionStorage.getItem(`notified_${minutesLeft}`);
      if (lastNotified) return;

      sessionStorage.setItem(`notified_${minutesLeft}`, 'true');

      const settings = JSON.parse(localStorage.getItem('settings') || '{"soundEnabled":true}');

      if (minutesLeft === 0) {
        // おでかけ時刻: ブラウザ通知（スマホのデフォルト音が鳴る）
        if ('Notification' in window && Notification.permission === 'granted') {
          new Notification('おでかけの時間です！', {
            body: 'いってらっしゃい！',
            icon: '/favicon.svg',
            tag: 'departure-alarm',
            requireInteraction: true, // ユーザーが閉じるまで表示
            vibrate: [200, 100, 200] // バイブレーション
          });
        }
      } else {
        // カウントダウン通知: 音声 + ブラウザ通知
        if (settings.soundEnabled && 'speechSynthesis' in window) {
          const utterance = new SpeechSynthesisUtterance(`おでかけ${minutesLeft}分前です`);
          utterance.lang = 'ja-JP';
          speechSynthesis.speak(utterance);
        }

        if ('Notification' in window && Notification.permission === 'granted') {
          new Notification('おでかけカウントダウン', {
            body: `おでかけ${minutesLeft}分前です`,
            icon: '/favicon.svg',
            tag: `countdown-${minutesLeft}`
          });
        }
      }
    }

    // 天気情報の取得
    async function fetchWeather() {
      const weatherInfoEl = document.getElementById('weather-info');
      if (!weatherInfoEl) return;

      try {
        if (!('geolocation' in navigator)) {
          throw new Error('位置情報が利用できません');
        }

        const position = await new Promise<GeolocationPosition>((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(resolve, reject);
        });

        const { latitude, longitude } = position.coords;
        
        // OpenWeatherMap APIキーは環境変数から取得（本番環境ではサーバーサイドで処理）
        // ここではダミーデータを表示
        const weatherData: WeatherData = {
          temp: 8,
          description: '晴れ',
          icon: '☀️'
        };

        weatherInfoEl.innerHTML = `
          <div class="weather-display">
            <div class="weather-icon">${weatherData.icon}</div>
            <div class="weather-details">
              <div class="weather-temp">${weatherData.temp}℃</div>
              <div class="weather-desc">${weatherData.description}</div>
            </div>
          </div>
        `;
      } catch (error) {
        weatherInfoEl.innerHTML = `
          <div class="weather-display">
            <div class="weather-details">
              <div class="weather-desc">天気情報を取得できませんでした</div>
            </div>
          </div>
        `;
      }
    }

    // アラーム設定エリアのクリックイベント
    const alarmStatus = document.getElementById('alarm-status');
    if (alarmStatus) {
      alarmStatus.addEventListener('click', () => {
        window.location.href = '/alarms';
      });
    }

    // 初期化
    updateDateTime();
    displayAlarmInfo();
    fetchWeather();

    // 通知許可をリクエスト
    if ('Notification' in window && Notification.permission === 'default') {
      Notification.requestPermission();
    }

    // 定期更新
    setInterval(() => {
      updateDateTime();
      const stored = localStorage.getItem('alarmPatterns');
      if (stored) {
        const patterns: AlarmPattern[] = JSON.parse(stored);
        const activePattern = patterns.find(p => p.isActive);
        if (activePattern) {
          updateCountdown(activePattern);
        }
      }
    }, 1000);
  </script>
</Layout>
